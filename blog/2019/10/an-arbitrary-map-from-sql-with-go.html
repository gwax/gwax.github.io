<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#" vocab="http://ogp.me/ns">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <title>An Arbitrary map from SQL with Go | gwax</title>
  <link href="/assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
  <link href="/assets/css/normalize.min.css" rel="stylesheet" type="text/css">
  <link href="/assets/css/skeleton.min.css" rel="stylesheet" type="text/css">
  <link href="/assets/css/rst_base.css" rel="stylesheet" type="text/css">
  <link href="/assets/css/code.css" rel="stylesheet" type="text/css">
  <link href="/assets/css/theme.css" rel="stylesheet" type="text/css">
  <meta content="#304FE1" name="theme-color">
  <meta content="Nikola (getnikola.com)" name="generator">
  <link href="/rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
  <link href="https://gwax.com/blog/2019/10/an-arbitrary-map-from-sql-with-go.html" rel="canonical">
  <link href="/favicon.ico" rel="icon" sizes="32x32"><!--[if lt IE 9]><script src="/assets/js/html5shiv-printshiv.min.js"></script><![endif]-->
  <meta content="George Leslie-Waksman" name="author">
  <link href="/blog/2017/11/grenadine.html" rel="prev" title="Grenadine" type="text/html">
  <link href="/blog/2019/10/uncut-jewel.html" rel="next" title="Uncut Jewel" type="text/html">
  <meta content="gwax" property="og:site_name">
  <meta content="An Arbitrary map from SQL with Go" property="og:title">
  <meta content="https://gwax.com/blog/2019/10/an-arbitrary-map-from-sql-with-go.html" property="og:url">
  <meta content="I've been writing a lot of Go lately and finding it a pleasant balance of simplicity, power, functionality, and ecosystem support. In a lot of cases, I am finding the guarantees afforded by type safet" property="og:description">
  <meta content="article" property="og:type">
  <meta content="2019-10-21T04:13:56Z" property="article:published_time">
  <meta content="code snippets" property="article:tag">
  <meta content="golang" property="article:tag">
</head>
<body>
  <div class="container">
    <header id="header">
      <div class="row">
        <div class="six columns">
          <h1 class="title" id="brand"><a href="/" rel="home" title="gwax"><span id="blog-title">gwax</span></a></h1>
        </div>
      </div>
    </header>
    <nav class="bar">
      <ul>
        <li>
          <a href="/projects.html">Projects</a>
        </li>
        <li>
          <span>Blog</span>
          <ul>
            <li>
              <a href="/index.html">Posts</a>
            </li>
            <li>
              <a href="/archive.html">Archives</a>
            </li>
            <li>
              <a href="/categories/index.html">Tags & Categories</a>
            </li>
            <li>
              <a href="/rss.xml">RSS feed</a>
            </li>
          </ul>
        </li>
        <li>
          <span>About</span>
          <ul>
            <li>
              <a href="/about/about-person.html">The person</a>
            </li>
            <li>
              <a href="/about/about-site.html">The site</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="/about/about-person.html#contact">Contact</a>
        </li>
      </ul>
    </nav>
    <nav class="select">
      <select>
        <option value="/projects.html">
          Projects
        </option>
        <optgroup label="Blog">
          <option value="/index.html">
            Posts
          </option>
          <option value="/archive.html">
            Archives
          </option>
          <option value="/categories/index.html">
            Tags & Categories
          </option>
          <option value="/rss.xml">
            RSS feed
          </option>
        </optgroup>
        <optgroup label="About">
          <option value="/about/about-person.html">
            The person
          </option>
          <option value="/about/about-site.html">
            The site
          </option>
        </optgroup>
        <option value="/about/about-person.html#contact">
          Contact
        </option>
      </select>
    </nav>
    <main id="content">
      <article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
        <header>
          <h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href="/blog/2019/10/an-arbitrary-map-from-sql-with-go.html">An Arbitrary map from SQL with Go</a></h1>
          <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">George Leslie-Waksman</span></p>
            <p class="dateline"><a href="/blog/2019/10/an-arbitrary-map-from-sql-with-go.html" rel="bookmark"><time class="published dt-published" datetime="2019-10-21T04:13:56Z" itemprop="datePublished" title="2019-10-21 04:13 UTC">2019-10-21 04:13 UTC</time></a></p>
            <p class="sourceline"><a class="sourcelink" href="/blog/2019/10/an-arbitrary-map-from-sql-with-go.rst">Source</a></p>
          </div>
        </header>
        <div class="e-content entry-content" itemprop="articleBody text">
          <p>I've been writing a lot of <a class="reference external" href="https://golang.org/">Go</a> lately and finding it a pleasant balance of simplicity, power, functionality, and ecosystem support. In a lot of cases, I am finding the guarantees afforded by type safety to be really nice but, occasionally, the strict requirements can make some easy things much harder than I want them to be.</p>
          <p>Recently, I found myself wanting to test the behavior of some code the hit a SQL database. Specifically, I wanted to check the results of a handful of queries with varied columns and column types. With <a class="reference external" href="https://www.python.org/">Python</a>, I'd approach this with <a class="reference external" href="https://www.sqlalchemy.org/">SQLAlchemy</a>, and turn the result into a <code>list</code> of <code>dict</code>s.</p>
          <pre class="code python"><a id="rest_code_d746e7ca6bf24b38b4916b54b969bc0a-1" name="rest_code_d746e7ca6bf24b38b4916b54b969bc0a-1"></a><span class="k">def</span> <span class="nf">rows_to_dicts</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
<a id="rest_code_d746e7ca6bf24b38b4916b54b969bc0a-2" name="rest_code_d746e7ca6bf24b38b4916b54b969bc0a-2"></a>    <span class="sd">"""Covert a SQLAlchemy RowProxy into a list of dicts."""</span>
<a id="rest_code_d746e7ca6bf24b38b4916b54b969bc0a-3" name="rest_code_d746e7ca6bf24b38b4916b54b969bc0a-3"></a>    <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
</pre>
          <p>From here, it's pretty straightforward to assert the result matches expectations. If you're using <a class="reference external" href="https://docs.pytest.org/en/latest/">pytest</a>, you'll also get really clear details on where the results aren't what you expect. If you don't have the expected columns or column types spot on, you're assertion will be off but you won't hit any underlying errors at this point of your testing.</p>
          <p><a class="reference external" href="https://golang.org/">Go</a>, on the other hand doesn't have quite as easy an option. The crux of the problem is that the only way to get a result row out of a sql query is via <a class="reference external" href="https://golang.org/pkg/database/sql/#Rows.Scan">(*Rows) Scan</a>, which demands you know something about the structure of the result before you query. Luckily <code>Scan</code> is happy to read anything into a <code>*string</code> as long as you're asking for the right number of values so we can write an equivalent function to the python list comprehension.</p>
          <pre class="code go"><a id="rest_code_8f61d469a5124f9992ca1509327a9e86-1" name="rest_code_8f61d469a5124f9992ca1509327a9e86-1"></a><span class="kn">import</span> <span class="p">(</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-2" name="rest_code_8f61d469a5124f9992ca1509327a9e86-2"></a>    <span class="s">"database/sql"</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-3" name="rest_code_8f61d469a5124f9992ca1509327a9e86-3"></a><span class="p">)</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-4" name="rest_code_8f61d469a5124f9992ca1509327a9e86-4"></a>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-5" name="rest_code_8f61d469a5124f9992ca1509327a9e86-5"></a><span class="kd">func</span> <span class="nx">RowsToMaps</span><span class="p">(</span><span class="nx">rows</span> <span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">Rows</span><span class="p">)</span> <span class="p">([]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-6" name="rest_code_8f61d469a5124f9992ca1509327a9e86-6"></a>    <span class="nx">columns</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">Columns</span><span class="p">()</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-7" name="rest_code_8f61d469a5124f9992ca1509327a9e86-7"></a>    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-8" name="rest_code_8f61d469a5124f9992ca1509327a9e86-8"></a>        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-9" name="rest_code_8f61d469a5124f9992ca1509327a9e86-9"></a>    <span class="p">}</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-10" name="rest_code_8f61d469a5124f9992ca1509327a9e86-10"></a>    <span class="nx">columnCount</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">columns</span><span class="p">)</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-11" name="rest_code_8f61d469a5124f9992ca1509327a9e86-11"></a>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-12" name="rest_code_8f61d469a5124f9992ca1509327a9e86-12"></a>    <span class="nx">cursor</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kd">interface</span><span class="p">{},</span> <span class="nx">columnCount</span><span class="p">)</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-13" name="rest_code_8f61d469a5124f9992ca1509327a9e86-13"></a>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">columnCount</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-14" name="rest_code_8f61d469a5124f9992ca1509327a9e86-14"></a>        <span class="kd">var</span> <span class="nx">columnValue</span> <span class="kt">string</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-15" name="rest_code_8f61d469a5124f9992ca1509327a9e86-15"></a>        <span class="nx">cursor</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="o">&</span><span class="nx">columnValue</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-16" name="rest_code_8f61d469a5124f9992ca1509327a9e86-16"></a>    <span class="p">}</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-17" name="rest_code_8f61d469a5124f9992ca1509327a9e86-17"></a>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-18" name="rest_code_8f61d469a5124f9992ca1509327a9e86-18"></a>    <span class="kd">var</span> <span class="nx">resultMaps</span> <span class="p">[]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-19" name="rest_code_8f61d469a5124f9992ca1509327a9e86-19"></a>    <span class="k">for</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span> <span class="p">{</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-20" name="rest_code_8f61d469a5124f9992ca1509327a9e86-20"></a>        <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">Scan</span><span class="p">(</span><span class="nx">cursor</span><span class="o">...</span><span class="p">)</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-21" name="rest_code_8f61d469a5124f9992ca1509327a9e86-21"></a>        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-22" name="rest_code_8f61d469a5124f9992ca1509327a9e86-22"></a>            <span class="k">return</span> <span class="nx">resultMaps</span><span class="p">,</span> <span class="nx">err</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-23" name="rest_code_8f61d469a5124f9992ca1509327a9e86-23"></a>        <span class="p">}</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-24" name="rest_code_8f61d469a5124f9992ca1509327a9e86-24"></a>        <span class="nx">rowMap</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">columnCount</span><span class="p">)</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-25" name="rest_code_8f61d469a5124f9992ca1509327a9e86-25"></a>        <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">columnPtr</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cursor</span> <span class="p">{</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-26" name="rest_code_8f61d469a5124f9992ca1509327a9e86-26"></a>            <span class="nx">key</span> <span class="o">:=</span> <span class="nx">columns</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-27" name="rest_code_8f61d469a5124f9992ca1509327a9e86-27"></a>            <span class="kd">var</span> <span class="nx">columnStr</span> <span class="kt">string</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-28" name="rest_code_8f61d469a5124f9992ca1509327a9e86-28"></a>            <span class="k">if</span> <span class="nx">columnStrPtr</span> <span class="o">:=</span> <span class="nx">columnPtr</span><span class="p">.(</span><span class="o">*</span><span class="kt">string</span><span class="p">);</span> <span class="nx">columnStrPtr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-29" name="rest_code_8f61d469a5124f9992ca1509327a9e86-29"></a>                <span class="nx">columnStr</span> <span class="p">=</span> <span class="o">*</span><span class="nx">columnStrPtr</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-30" name="rest_code_8f61d469a5124f9992ca1509327a9e86-30"></a>            <span class="p">}</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-31" name="rest_code_8f61d469a5124f9992ca1509327a9e86-31"></a>            <span class="nx">rowMap</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="nx">columnStr</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-32" name="rest_code_8f61d469a5124f9992ca1509327a9e86-32"></a>        <span class="p">}</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-33" name="rest_code_8f61d469a5124f9992ca1509327a9e86-33"></a>        <span class="nx">resultMaps</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">resultMaps</span><span class="p">,</span> <span class="nx">rowMap</span><span class="p">)</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-34" name="rest_code_8f61d469a5124f9992ca1509327a9e86-34"></a>    <span class="p">}</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-35" name="rest_code_8f61d469a5124f9992ca1509327a9e86-35"></a>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-36" name="rest_code_8f61d469a5124f9992ca1509327a9e86-36"></a>        <span class="k">return</span> <span class="nx">resultMaps</span><span class="p">,</span> <span class="nx">err</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-37" name="rest_code_8f61d469a5124f9992ca1509327a9e86-37"></a>    <span class="p">}</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-38" name="rest_code_8f61d469a5124f9992ca1509327a9e86-38"></a>    <span class="k">return</span> <span class="nx">resultMaps</span><span class="p">,</span> <span class="kc">nil</span>
<a id="rest_code_8f61d469a5124f9992ca1509327a9e86-39" name="rest_code_8f61d469a5124f9992ca1509327a9e86-39"></a><span class="p">}</span>
</pre>
          <p>This, much like the <a class="reference external" href="https://www.python.org/">Python</a> above, gives us a list of maps of column name to column value, with the minor caveats that all values are strings and <code>NULL</code> values become empty strings. I found it a useful chunk of code, so I thought I'd throw it up.</p>
          <p>Sure, it's more verbose but sometimes that's the price we pay for dealing with dynamic results in a staticly typed language. There are other prices paid in the other direction.</p>
        </div>
        <aside class="postpromonav">
          <nav>
            <div class="row tags" itemprop="keywords">
              <a class="tag p-category button button-primary" href="/categories/code-snippets.html" rel="tag">code snippets</a> <a class="tag p-category button button-primary" href="/categories/golang.html" rel="tag">golang</a>
            </div>
            <div class="row pager hidden-print">
              <a class="button u-pull-left previous" href="/blog/2017/11/grenadine.html" rel="prev" title="Grenadine">Previous post</a> <a class="button u-pull-right next" href="/blog/2019/10/uncut-jewel.html" rel="next" title="Uncut Jewel">Next post</a>
            </div>
          </nav>
        </aside>
      </article>
    </main>
    <footer id="footer">
      <p>Contents ©2004-2022 <a href="/about/about-person.html">George Leslie-Waksman</a> | Source: <img class="svg-icon" src="/icons/github.svg"><a href="https://github.com/gwax/www-gwax">GitHub</a> | Powered by <a href="https://getnikola.com">Nikola</a> | Styled with <a href="http://getskeleton.com">Skeleton</a> | <a href="https://creativecommons.org/licenses/by-sa/4.0/" rel="license"><img alt="Creative Commons License BY-SA" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" style="border:0;margin:0;"></a></p>
    </footer>
  </div>
  <script src="/assets/js/baguetteBox.min.js"></script>
  <script src="/assets/js/webfontloader.js"></script>
  <script src="/assets/js/fancydates.js"></script>
  <script src="/assets/js/theme.js"></script><!-- fancy dates -->
  <script>

    fancydates(1);
  </script><!-- end fancy dates -->
  <script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    WebFont.load({
        google: {
            families: ['IBM Plex Mono', 'Raleway', 'Pacifico']
        }
    });
  </script>
</body>
</html>
